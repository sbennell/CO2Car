<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Race Timer</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 4rem;
            font-weight: bold;
            color: #212529;
        }
        .lane-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .status-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        .status-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .control-btn {
            width: 120px;
            margin: 0.5rem;
        }
        .system-status {
            font-size: 0.9rem;
        }
        .system-status i {
            margin-right: 0.5rem;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .version-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand">COâ‚‚ Race Timer</span>
            <span class="version-info text-light">v0.11.3</span>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-4">
            <!-- Race Status Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div id="status" class="status-badge badge bg-secondary mb-3">IDLE</div>
                        <div id="timer" class="timer-display">00:00.000</div>
                    </div>
                </div>
            </div>

            <!-- Lane Times Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-6 mb-4 mb-md-0">
                                <h4>Lane 1</h4>
                                <div id="lane1-time" class="lane-time">--:--.---</div>
                            </div>
                            <div class="col-md-6">
                                <h4>Lane 2</h4>
                                <div id="lane2-time" class="lane-time">--:--.---</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Race Controls</h5>
                        <button id="btnLoad" class="btn btn-warning control-btn" disabled>
                            <i class="fas fa-upload"></i> Load
                        </button>
                        <button id="btnStart" class="btn btn-success control-btn" disabled>
                            <i class="fas fa-flag"></i> Start
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Status Card -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System Status</h5>
                        <div class="row system-status">
                            <div class="col-md-6">
                                <p><i class="fas fa-wifi text-success"></i> WiFi: Connected</p>
                                <p><i class="fas fa-microchip text-success"></i> Sensors: Ready</p>
                            </div>
                            <div class="col-md-6">
                                <p><i class="fas fa-bolt text-success"></i> Relay: Ready</p>
                                <p><i class="fas fa-sd-card text-success"></i> Storage: Available</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const btnLoad = document.getElementById('btnLoad');
        const btnStart = document.getElementById('btnStart');

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.hostname}/ws`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000);
                }
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'state':
                    updateStatus(data.data);
                    break;
                case 'time':
                    updateTimes(data);
                    break;
                case 'system_status':
                    updateSystemStatus(data.data);
                    break;
                case 'error':
                    showError(data.message);
                    break;
            }
        }

        function updateStatus(state) {
            const statusDiv = document.getElementById('status');
            let bgClass = 'bg-secondary';
            
            switch(state.toLowerCase()) {
                case 'ready':
                    bgClass = 'bg-warning';
                    btnStart.disabled = false;
                    btnLoad.disabled = true;
                    break;
                case 'running':
                    bgClass = 'bg-success';
                    btnStart.disabled = true;
                    btnLoad.disabled = true;
                    break;
                case 'finished':
                    bgClass = 'bg-info';
                    btnStart.disabled = true;
                    btnLoad.disabled = false;
                    break;
                default: // IDLE
                    btnStart.disabled = true;
                    btnLoad.disabled = false;
            }
            
            statusDiv.className = 'status-badge badge ' + bgClass;
            statusDiv.textContent = state;
        }

        function formatTime(ms) {
            if (!ms) return '--:--:---';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = ms % 1000;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        function updateTimes(data) {
            document.getElementById('timer').textContent = formatTime(data.elapsed);
            document.getElementById('lane1-time').textContent = formatTime(data.lane1);
            document.getElementById('lane2-time').textContent = formatTime(data.lane2);
        }

        function updateSystemStatus(status) {
            // Update WiFi status
            const wifiIcon = document.querySelector('.fa-wifi');
            wifiIcon.className = `fas fa-wifi text-${status.wifi ? 'success' : 'danger'}`;
            wifiIcon.nextSibling.textContent = ` WiFi: ${status.wifi ? 'Connected' : 'Disconnected'}`;

            // Update Sensors status
            const sensorIcon = document.querySelector('.fa-microchip');
            sensorIcon.className = `fas fa-microchip text-${status.sensors ? 'success' : 'danger'}`;
            sensorIcon.nextSibling.textContent = ` Sensors: ${status.sensors ? 'Ready' : 'Error'}`;

            // Update Relay status
            const relayIcon = document.querySelector('.fa-bolt');
            relayIcon.className = `fas fa-bolt text-${status.relay ? 'success' : 'danger'}`;
            relayIcon.nextSibling.textContent = ` Relay: ${status.relay ? 'Ready' : 'Error'}`;

            // Update Storage status
            const storageIcon = document.querySelector('.fa-sd-card');
            storageIcon.className = `fas fa-sd-card text-${status.storage ? 'success' : 'danger'}`;
            storageIcon.nextSibling.textContent = ` Storage: ${status.storage ? 'Available' : 'Error'}`;
        }

        function showError(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-danger border-0';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Add to container
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.appendChild(toast);
            document.body.appendChild(container);
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after hidden
            toast.addEventListener('hidden.bs.toast', () => container.remove());
        }

        // Add event listeners for buttons
        btnLoad.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'command', action: 'load' }));
        });

        btnStart.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'command', action: 'start' }));
        });

        // Connect when page loads
        connectWebSocket();

        // Request initial system status
        setTimeout(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'request', data: 'system_status' }));
            }
        }, 1000);
    </script>
</body>
</html>
