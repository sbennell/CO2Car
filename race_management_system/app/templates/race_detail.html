{% extends "base.html" %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.events') }}">Events</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.event_detail', event_id=race.event.id) }}">{{ race.event.name }}</a></li>
            <li class="breadcrumb-item active">Round {{ race.round_number }} - Heat {{ race.heat_number }}</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Round {{ race.round_number }} - Heat {{ race.heat_number }}</h1>
            <p class="lead">
                <strong>Event:</strong> {{ race.event.name }}<br>
                <strong>Start Time:</strong> {{ race.start_time.strftime('%H:%M') if race.start_time else 'Not started' }}<br>
                <strong>Status:</strong>
                {% if race.status == 'scheduled' %}
                    <span class="badge bg-primary">Scheduled</span>
                {% elif race.status == 'in_progress' %}
                    <span class="badge bg-warning">In Progress</span>
                {% elif race.status == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                {% endif %}
                <br>
                <strong>Race State:</strong> <span id="raceState" class="badge bg-secondary">Unknown</span>
            </p>
        </div>
        <div class="col-md-4 text-end">
            {% if race.status == 'scheduled' %}
                <button class="btn btn-success" id="startRaceBtn">Start Round</button>
            {% elif race.status == 'in_progress' %}
                <button class="btn btn-danger" id="endRaceBtn">End Race</button>
                <button class="btn btn-primary" id="fireRelayBtn" disabled>Start Race</button>
            {% endif %}
        </div>
    </div>

    <!-- Race Results -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Race Results</h5>
        </div>
        <div class="card-body">
            {% if results %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Racer</th>
                                <th>Car Number</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.position }}</td>
                                <td>{{ result.racer.name }}</td>
                                <td>{{ result.racer.car_number }}</td>
                                <td>{% if result.time is not none %}{{ "%.3f"|format(result.time) }}s{% else %}Not recorded{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No results available yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Live Race Data -->
    {% if race.status == 'in_progress' %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Live Race Data</h5>
        </div>
        <div class="card-body">
            <div id="liveRaceData">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Lane 1 {% for result in results %}{% if result.lane_number == 1 %}[{{ result.racer.name }}]{% endif %}{% endfor %}</h5>
                            </div>
                            <div class="card-body text-center">
                                <h2 id="lane1Time" class="display-4 mb-2">0.000</h2>
                                <div class="progress mb-3">
                                    <div id="lane1Progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p id="lane1Status" class="text-muted">Waiting for start...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Lane 2 {% for result in results %}{% if result.lane_number == 2 %}[{{ result.racer.name }}]{% endif %}{% endfor %}</h5>
                            </div>
                            <div class="card-body text-center">
                                <h2 id="lane2Time" class="display-4 mb-2">0.000</h2>
                                <div class="progress mb-3">
                                    <div id="lane2Progress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p id="lane2Status" class="text-muted">Waiting for start...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-3">
                    <h4 id="raceElapsedTime">Elapsed Time: 0.000s</h4>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if race.status == 'in_progress' %}
            // Connect to WebSocket for live race data
            const socket = io();
            let raceStartTime = null;
            let raceState = "UNKNOWN";
            let timerInterval = null;
            
            // Request initial hardware status when page loads
            fetch('/api/hardware/status')
                .then(response => response.json())
                .then(data => {
                    console.log('Initial hardware status:', data);
                    if (data.connected) {
                        // Update status display if connected
                        if (data.status && data.status.race_state) {
                            raceState = data.status.race_state;
                            updateRaceStateDisplay();
                        } else if (data.race_state) {
                            // Alternative data format
                            raceState = data.race_state;
                            updateRaceStateDisplay();
                        }
                    } else {
                        // Show disconnected state
                        document.getElementById('raceState').textContent = "DISCONNECTED";
                        document.getElementById('raceState').className = "badge bg-danger";
                    }
                })
                .catch(error => {
                    console.error('Error fetching hardware status:', error);
                });
            
            // Handle hardware status updates
            socket.on('hardware_status', function(data) {
                console.log('Hardware status update:', data);
                
                // Handle different data formats
                if (data.status && data.status.race_state) {
                    raceState = data.status.race_state;
                    updateRaceStateDisplay();
                } else if (data.race_state) {
                    raceState = data.race_state;
                    updateRaceStateDisplay();
                } else if (typeof data === 'object') {
                    // Log what fields are actually available for debugging
                    console.log('Available fields in hardware_status:', Object.keys(data));
                    
                    // Try to find race_state in the data object at any level
                    for (const key in data) {
                        if (typeof data[key] === 'object' && data[key] !== null) {
                            if (data[key].race_state) {
                                console.log('Found race_state in nested object:', key);
                                raceState = data[key].race_state;
                                updateRaceStateDisplay();
                                break;
                            }
                        }
                    }
                }
            });
            
            // Race started event
            socket.on('race_start', function(data) {
                console.log('Race start:', data);
                raceStartTime = Date.now();
                
                document.getElementById('lane1Status').textContent = 'Racing...';
                document.getElementById('lane2Status').textContent = 'Racing...';
                
                // Start elapsed time counter
                clearInterval(timerInterval);
                timerInterval = setInterval(updateElapsedTime, 100);
            });
            
            // Race update event
            socket.on('race_update', function(data) {
                console.log('Race update:', data);
                
                // Update lane 1 data
                if (data.car1_finished) {
                    const time = (data.car1_time / 1000).toFixed(3);
                    document.getElementById('lane1Time').textContent = time;
                    document.getElementById('lane1Status').textContent = 'Finished!';
                    document.getElementById('lane1Status').classList.add('text-success');
                    document.getElementById('lane1Progress').style.width = '100%';
                }
                
                // Update lane 2 data
                if (data.car2_finished) {
                    const time = (data.car2_time / 1000).toFixed(3);
                    document.getElementById('lane2Time').textContent = time;
                    document.getElementById('lane2Status').textContent = 'Finished!';
                    document.getElementById('lane2Status').classList.add('text-success');
                    document.getElementById('lane2Progress').style.width = '100%';
                }
                
                // Update progress bars for lanes that haven't finished
                const elapsedMs = data.elapsed_time || 0;
                const estimatedMaxTime = 5000; // 5 seconds estimated max time
                
                if (!data.car1_finished) {
                    const progress = Math.min(100, (elapsedMs / estimatedMaxTime) * 100);
                    document.getElementById('lane1Progress').style.width = progress + '%';
                }
                
                if (!data.car2_finished) {
                    const progress = Math.min(100, (elapsedMs / estimatedMaxTime) * 100);
                    document.getElementById('lane2Progress').style.width = progress + '%';
                }
            });
            
            // Race completed event
            socket.on('race_completed', function(data) {
                console.log('Race completed:', data);
                clearInterval(timerInterval);
                
                // Determine winner and update UI
                const car1Time = (data.car1_time / 1000).toFixed(3);
                const car2Time = (data.car2_time / 1000).toFixed(3);
                
                document.getElementById('lane1Time').textContent = car1Time;
                document.getElementById('lane2Time').textContent = car2Time;
                
                document.getElementById('lane1Status').textContent = 'Finished';
                document.getElementById('lane2Status').textContent = 'Finished';
                
                document.getElementById('lane1Progress').style.width = '100%';
                document.getElementById('lane2Progress').style.width = '100%';
                
                // Highlight winner
                if (data.winner === 'car1') {
                    document.getElementById('lane1Status').textContent = 'Winner!';
                    document.getElementById('lane1Status').classList.add('text-success', 'fw-bold');
                } else if (data.winner === 'car2') {
                    document.getElementById('lane2Status').textContent = 'Winner!';
                    document.getElementById('lane2Status').classList.add('text-success', 'fw-bold');
                } else {
                    // Tie
                    document.getElementById('lane1Status').textContent = 'Tie!';
                    document.getElementById('lane2Status').textContent = 'Tie!';
                    document.getElementById('lane1Status').classList.add('text-warning', 'fw-bold');
                    document.getElementById('lane2Status').classList.add('text-warning', 'fw-bold');
                }
                
                // After a short delay, refresh page to update race status
                setTimeout(function() {
                    location.reload();
                }, 5000);
            });
            
            // Function to update elapsed time display
            function updateElapsedTime() {
                if (!raceStartTime) return;
                
                const elapsed = Date.now() - raceStartTime;
                const seconds = (elapsed / 1000).toFixed(3);
                document.getElementById('raceElapsedTime').textContent = `Elapsed Time: ${seconds}s`;
            }
            
            // Function to update race state display and button state
            function updateRaceStateDisplay() {
                const raceStateElement = document.getElementById('raceState');
                raceStateElement.textContent = raceState;
                
                // Update badge color based on state
                raceStateElement.className = "badge";
                switch(raceState) {
                    case "IDLE":
                        raceStateElement.classList.add("bg-secondary");
                        break;
                    case "CARS_LOADED":
                        raceStateElement.classList.add("bg-info");
                        break;
                    case "RACE_READY":
                        raceStateElement.classList.add("bg-primary");
                        break;
                    case "COUNTDOWN":
                        raceStateElement.classList.add("bg-warning");
                        break;
                    case "RACING":
                        raceStateElement.classList.add("bg-danger");
                        break;
                    case "RACE_FINISHED":
                        raceStateElement.classList.add("bg-success");
                        break;
                    default:
                        raceStateElement.classList.add("bg-secondary");
                }
                
                // Enable/disable the Start Race button based on race state
                const fireRelayBtn = document.getElementById('fireRelayBtn');
                if (fireRelayBtn) {
                    if (raceState === "CARS_LOADED") {
                        fireRelayBtn.disabled = false;
                        fireRelayBtn.title = "Cars loaded and ready to race";
                    } else {
                        fireRelayBtn.disabled = true;
                        fireRelayBtn.title = "Cars must be loaded before firing relay";
                    }
                }
            }
        {% endif %}

        // Handle race control buttons
        const startRaceBtn = document.getElementById('startRaceBtn');
        const endRaceBtn = document.getElementById('endRaceBtn');

        if (startRaceBtn) {
            startRaceBtn.addEventListener('click', function() {
                fetch('{{ url_for("main.start_race", race_id=race.id) }}', {
                    method: 'POST'
                }).then(function(response) {
                    if (response.ok) {
                        location.reload();
                    }
                });
            });
        }

        if (endRaceBtn) {
            endRaceBtn.addEventListener('click', function() {
                fetch('{{ url_for("main.end_race", race_id=race.id) }}', {
                    method: 'POST'
                }).then(function(response) {
                    if (response.ok) {
                        location.reload();
                    }
                });
            });
        }

        // Handle fire relay button
        const fireRelayBtn = document.getElementById('fireRelayBtn');
        if (fireRelayBtn) {
            // Use a flag to track if a request is in progress
            let relayRequestInProgress = false;
            
            // Only attach the event listener once
            fireRelayBtn.addEventListener('click', function handleRelayClick(event) {
                // Prevent double-clicks or clicks while a request is in progress
                if (relayRequestInProgress) {
                    console.log('Ignoring click - request already in progress');
                    return;
                }
                
                // Only allow if race state is CARS_LOADED
                if (raceState !== "CARS_LOADED") {
                    alert("Cars must be loaded before starting the race.");
                    return;
                }
                
                if (confirm('Are you sure you want to start the race?')) {
                    // Set flag to prevent multiple requests
                    relayRequestInProgress = true;
                    
                    // Disable button immediately
                    fireRelayBtn.disabled = true;
                    fireRelayBtn.textContent = 'Starting race...';
                    
                    fetch('/api/hardware/send_command', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            command: 'startRace',
                            race_id: '{{ race.id }}'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Race started successfully');
                            // Change button appearance to show it was triggered
                            fireRelayBtn.classList.remove('btn-primary');
                            fireRelayBtn.classList.add('btn-success');
                            fireRelayBtn.textContent = 'Race Started';
                            
                            // Remove the click event to prevent further clicks
                            fireRelayBtn.removeEventListener('click', handleRelayClick);
                        } else {
                            alert('Error starting race: ' + data.message);
                            // Reset button if there was an error
                            fireRelayBtn.disabled = false;
                            fireRelayBtn.textContent = 'Fire Relay';
                            relayRequestInProgress = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error communicating with the server');
                        // Reset button if there was an error
                        fireRelayBtn.disabled = false;
                        fireRelayBtn.textContent = 'Fire Relay';
                        relayRequestInProgress = false;
                    });
                }
            });
        }
    });
</script>
{% endblock %}
{% endblock %}
